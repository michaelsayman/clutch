#!/bin/bash
# Clutch - AI-Powered Repository Documentation Tool
# Version: 1.0.0

set -e

CLUTCH_DIR="${CLUTCH_DIR:-$HOME/.clutch}"
VERSION="1.0.0"

# Colors (minimal, like Claude Code)
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# ============================================================================
# COMMANDS
# ============================================================================

cmd_interactive() {
    while true; do
        echo ""
        echo "${BOLD}Clutch${NC} - AI-powered repository documentation"
        echo ""
        echo "What would you like to do?"
        echo ""
        echo "  1) Initialize a new repository"
        echo "  2) Process files"
        echo "  3) View project status"
        echo "  4) Uninstall clutch"
        echo "  5) Show help"
        echo "  6) Exit"
        echo ""
        read -p "Choice [1-6]: " choice

        case $choice in
            1)
                echo ""
                read -p "Enter repository URL: " repo_url
                if [ -n "$repo_url" ]; then
                    cmd_init "$repo_url"
                    read -p "Press Enter to continue..."
                fi
                ;;
            2)
                cmd_run ""
                read -p "Press Enter to continue..."
                ;;
            3)
                cmd_status
                read -p "Press Enter to continue..."
                ;;
            4)
                echo ""
                read -p "Are you sure you want to uninstall? [y/N]: " confirm
                if [[ "$confirm" =~ ^[Yy]$ ]]; then
                    cmd_uninstall
                    exit 0
                fi
                ;;
            5)
                cmd_help
                read -p "Press Enter to continue..."
                ;;
            6)
                echo ""
                echo "Goodbye!"
                echo ""
                exit 0
                ;;
            *)
                echo ""
                echo "Invalid choice. Please select 1-6."
                sleep 1
                ;;
        esac
    done
}

cmd_help() {
    cat << EOF
Usage: clutch [options] [command]

Clutch - AI-powered file description generator for GitHub repositories

Commands:
  init <repo-url>         Initialize a new repository for processing
  run [project]           Process files with AI workers
  status                  Show all projects and their progress
  uninstall               Remove clutch from your system
  help                    Display help for command

Options:
  -h, --help              Display help for command
  --version               Output the version number

Examples:
  clutch init https://github.com/facebook/react
  clutch status
  clutch run react

Learn more: https://github.com/michaelsayman/clutch
EOF
}

cmd_init() {
    local REPO_URL="$1"

    if [ -z "$REPO_URL" ]; then
        echo "ERROR: Repository URL required" >&2
        echo "" >&2
        echo "Usage: clutch init <repo-url>" >&2
        echo "" >&2
        echo "Example:" >&2
        echo "  clutch init https://github.com/facebook/react" >&2
        echo "" >&2
        exit 1
    fi

    mkdir -p "$CLUTCH_DIR/repos" "$CLUTCH_DIR/projects"

    local REPO_NAME=$(basename -s .git "$REPO_URL")
    local REPO_DIR="$CLUTCH_DIR/repos/$REPO_NAME"
    local PROJECT_DIR="$CLUTCH_DIR/projects/$REPO_NAME"

    echo ""
    echo "${BOLD}Initializing repository${NC}"
    echo ""
    echo "Repository: $REPO_NAME"
    echo "URL: $REPO_URL"
    echo ""

    mkdir -p "$PROJECT_DIR"

    # Clone or update repo
    if [ -d "$REPO_DIR" ]; then
        echo "→ Using existing repository clone"
    else
        echo "→ Cloning repository..."
        git clone "$REPO_URL" "$REPO_DIR" 2>&1 | grep -E "(Cloning|done)" || true
    fi

    # Find files
    echo "→ Analyzing files..."
    find "$REPO_DIR" -type f \
        ! -path "*/node_modules/*" ! -path "*/.git/*" ! -path "*/dist/*" \
        ! -path "*/build/*" ! -path "*/.next/*" ! -path "*/coverage/*" \
        ! -path "*/__pycache__/*" ! -path "*/.cache/*" ! -path "*/vendor/*" \
        ! -name "package-lock.json" ! -name "yarn.lock" ! -name "*.min.js" \
        ! -name "*.map" ! -name "*.log" > "$PROJECT_DIR/all_files.txt"

    local TOTAL_FILES=$(wc -l < "$PROJECT_DIR/all_files.txt" | tr -d ' ')

    # Count LOC
    echo "→ Counting lines of code..."
    local TOTAL_LOC=0
    > "$PROJECT_DIR/file_stats.txt"

    while IFS= read -r file; do
        if [ -f "$file" ]; then
            local LOC=$(wc -l < "$file" 2>/dev/null | tr -d ' ')
            [ -z "$LOC" ] && LOC=0
            TOTAL_LOC=$((TOTAL_LOC + LOC))
            echo "$file|$LOC" >> "$PROJECT_DIR/file_stats.txt"
        fi
    done < "$PROJECT_DIR/all_files.txt"

    echo "→ Generating project context..."
    claude --dangerously-skip-permissions -p "Analyze repository at $REPO_DIR and create PROJECT_CONTEXT.md at $PROJECT_DIR/PROJECT_CONTEXT.md with: project purpose, architecture, technologies, repo structure, main features. Then append 'SUCCESS' to $PROJECT_DIR/init_log.txt and EXIT." 2>/dev/null || true

    # Initialize files
    > "$PROJECT_DIR/completed.txt"
    > "$PROJECT_DIR/descriptions.jsonl"
    > "$PROJECT_DIR/live_log.txt"
    > "$PROJECT_DIR/active_workers.txt"

    # Save metadata
    cat > "$PROJECT_DIR/metadata.json" <<EOF
{
  "repo_name": "$REPO_NAME",
  "repo_url": "$REPO_URL",
  "total_files": $TOTAL_FILES,
  "total_loc": $TOTAL_LOC,
  "init_date": "$(date '+%Y-%m-%d %H:%M:%S')"
}
EOF

    echo ""
    echo "✓ Initialization complete"
    echo ""
    printf "  Files found: ${BOLD}%s${NC}\n" "$TOTAL_FILES"
    printf "  Lines of code: ${BOLD}%s${NC}\n" "$(printf "%'d" $TOTAL_LOC)"
    if [ -f "$PROJECT_DIR/PROJECT_CONTEXT.md" ]; then
        printf "  Context: ${BOLD}Generated${NC}\n"
    fi
    echo ""
    echo "Next: ${BOLD}clutch run $REPO_NAME${NC}"
    echo ""
}

cmd_status() {
    echo ""
    echo "${BOLD}Projects${NC}"
    echo ""

    if [ ! -d "$CLUTCH_DIR/projects" ] || [ -z "$(ls -A "$CLUTCH_DIR/projects" 2>/dev/null)" ]; then
        echo "No projects initialized"
        echo ""
        echo "Initialize a project:"
        echo "  ${BOLD}clutch init <repo-url>${NC}"
        echo ""
        exit 0
    fi

    local projects=($(ls -1 "$CLUTCH_DIR/projects/"))

    for project in "${projects[@]}"; do
        local metadata="$CLUTCH_DIR/projects/$project/metadata.json"
        if [ ! -f "$metadata" ]; then continue; fi

        local total=$(jq -r '.total_files' "$metadata" 2>/dev/null)
        local completed=$(wc -l < "$CLUTCH_DIR/projects/$project/completed.txt" 2>/dev/null | tr -d ' ')
        [ -z "$completed" ] && completed=0

        local pct=0
        [ "$total" -gt 0 ] && pct=$(echo "scale=0; $completed * 100 / $total" | bc 2>/dev/null || echo "0")

        local status_icon="⋯"
        [ "$completed" -eq "$total" ] && status_icon="✓"
        [ "$completed" -eq 0 ] && status_icon="○"

        printf "  ${status_icon} %-30s %3d%% complete (%d/%d files)\n" "$project" "$pct" "$completed" "$total"
    done
    echo ""
}

cmd_run() {
    local project_name="$1"

    mkdir -p "$CLUTCH_DIR/projects"

    # Select project
    if [ -z "$project_name" ]; then
        local projects=($(ls -1 "$CLUTCH_DIR/projects/" 2>/dev/null))

        if [ ${#projects[@]} -eq 0 ]; then
            echo "" >&2
            echo "No projects found" >&2
            echo "" >&2
            echo "Initialize a project first:" >&2
            echo "  clutch init <repo-url>" >&2
            echo "" >&2
            exit 1
        elif [ ${#projects[@]} -eq 1 ]; then
            project_name="${projects[0]}"
        else
            echo ""
            echo "${BOLD}Select project${NC}"
            echo ""
            for i in "${!projects[@]}"; do
                local proj="${projects[$i]}"
                local completed=$(wc -l < "$CLUTCH_DIR/projects/$proj/completed.txt" 2>/dev/null | tr -d ' ')
                local total=$(jq -r '.total_files' "$CLUTCH_DIR/projects/$proj/metadata.json" 2>/dev/null)
                printf "  %d) %-30s (%d/%d files)\n" "$((i+1))" "$proj" "$completed" "$total"
            done
            echo ""
            read -p "Choice [1-${#projects[@]}]: " choice
            if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#projects[@]}" ]; then
                project_name="${projects[$((choice-1))]}"
            else
                echo "" >&2
                echo "Invalid selection" >&2
                exit 1
            fi
        fi
    fi

    local project_dir="$CLUTCH_DIR/projects/$project_name"
    if [ ! -d "$project_dir" ]; then
        echo "" >&2
        echo "ERROR: Project '$project_name' not found" >&2
        echo "" >&2
        echo "Available projects:" >&2
        ls -1 "$CLUTCH_DIR/projects/" 2>/dev/null | sed 's/^/  /' >&2
        echo "" >&2
        exit 1
    fi

    # Run main processor
    run_processor "$project_dir" "$project_name"
}

run_processor() {
    local project_dir="$1"
    local project_name="$2"

    echo ""
    echo "${BOLD}Processing: $project_name${NC}"
    echo ""

    local total=$(wc -l < "$project_dir/all_files.txt" | tr -d ' ')
    local done=$(wc -l < "$project_dir/completed.txt" 2>/dev/null | tr -d ' ')
    [ -z "$done" ] && done=0
    local remaining=$((total - done))

    local pct=0
    [ "$total" -gt 0 ] && pct=$(echo "scale=0; $done * 100 / $total" | bc 2>/dev/null || echo "0")

    printf "Progress: ${BOLD}%d%%${NC} (%d/%d files, %d remaining)\n" "$pct" "$done" "$total" "$remaining"
    echo ""

    if [ "$remaining" -eq 0 ]; then
        echo "✓ All files processed"
        echo ""
        exit 0
    fi

    # Worker selection
    echo "Select worker count:"
    echo ""
    echo "  1) 10 workers     ${DIM}(slower, lower API usage)${NC}"
    echo "  2) 20 workers     ${DIM}(balanced)${NC}"
    echo "  3) 30 workers     ${DIM}(faster)${NC}"
    echo "  4) 40 workers     ${DIM}(high speed)${NC}"
    echo "  5) 50 workers     ${DIM}(maximum speed)${NC}"
    echo ""
    read -p "Choice [1-5]: " choice
    local workers=20
    case $choice in
        1) workers=10 ;; 2) workers=20 ;; 3) workers=30 ;; 4) workers=40 ;; 5) workers=50 ;;
    esac

    # Continue or restart?
    if [ "$done" -gt 0 ]; then
        echo ""
        read -p "Continue from checkpoint? [Y/n]: " cont
        if [[ "$cont" =~ ^[Nn] ]]; then
            > "$project_dir/completed.txt"
            > "$project_dir/descriptions.jsonl"
            echo "✓ Progress reset"
        fi
    fi

    echo ""
    echo "→ Starting $workers workers..."
    echo ""

    # Process files
    export CLUTCH_PROJECT_DIR="$project_dir"
    local pending=$(comm -23 <(sort "$project_dir/all_files.txt") <(sort "$project_dir/completed.txt" 2>/dev/null || echo ""))

    echo "$pending" | xargs -P "$workers" -I {} bash -c 'clutch --worker "{}"'

    echo ""
    echo "✓ Processing complete"
    echo ""
    echo "Output: ${BOLD}$project_dir/descriptions.jsonl${NC}"
    echo ""
}

cmd_worker() {
    local file="$1"
    local project_dir="$CLUTCH_PROJECT_DIR"

    [ -z "$project_dir" ] && exit 1
    grep -Fxq "$file" "$project_dir/completed.txt" 2>/dev/null && exit 0

    claude --dangerously-skip-permissions -p "Analyze ONE file from a code repository. Read $project_dir/PROJECT_CONTEXT.md for context, then read $file. Write a 2-5 sentence description (MAX 400 chars) explaining what it does, its role in the architecture, and key functionality. Append ONE JSON line to $project_dir/descriptions.jsonl: {\"file\":\"$file\",\"desc\":\"description\"}. Append file path to $project_dir/completed.txt. EXIT immediately." 2>/dev/null || true

    echo "$file" >> "$project_dir/completed.txt"
}

cmd_uninstall() {
    echo ""
    echo "${BOLD}Uninstalling Clutch${NC}"
    echo ""

    # Remove binary
    if [ -f "$HOME/.local/bin/clutch" ]; then
        echo "→ Removing binary..."
        rm -f "$HOME/.local/bin/clutch"
    fi

    # Remove data
    if [ -d "$CLUTCH_DIR" ]; then
        echo "→ Removing data..."
        rm -rf "$CLUTCH_DIR"
    fi

    echo ""
    echo "✓ Clutch uninstalled"
    echo ""
}

# ============================================================================
# MAIN ROUTER
# ============================================================================

case "${1:-interactive}" in
    init) cmd_init "$2" ;;
    run) cmd_run "$2" ;;
    status|list) cmd_status ;;
    uninstall) cmd_uninstall ;;
    --worker) cmd_worker "$2" ;;
    --version|-v)
        echo "$VERSION (Clutch)"
        ;;
    help|--help|-h) cmd_help ;;
    interactive|"") cmd_interactive ;;
    *)
        echo "Unknown command: $1" >&2
        echo "" >&2
        cmd_help
        exit 1
        ;;
esac
